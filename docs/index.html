<!doctype html>
<html lang="en" style="height: 100%;">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src-elem 'self' 'unsafe-inline' cdn.jsdelivr.net cxrtnc.leaningtech.com; script-src 'unsafe-eval' cxrtnc.leaningtech.com; style-src-elem cdn.jsdelivr.net 'self' 'unsafe-inline'; style-src cxrtnc.leaningtech.com 'self' 'unsafe-inline'; connect-src 'self' sat.vulns.ch cxrtnc.leaningtech.com; worker-src 'self' blob:"/>
    <title>SAT - vulns.ch</title>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js" integrity="sha256-/B3TGyIePl+SlIbgeoC0d6iq+dzitPnD/+fdJfNwZV0=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <script src="coi-serviceworker.js"></script>
    <script type="module">
      import * as CheerpX from "https://cxrtnc.leaningtech.com/1.2.2/cx.esm.js";
      self.CheerpX = CheerpX;
    </script>
    <script type="module">
      // The read-only disk image

      const blockDevice = (window.location.href.indexOf("localhost") > -1) ? await CheerpX.HttpBytesDevice.create("/disk-images/debian.ext2") : await CheerpX.GitHubDevice.create("https://sat.vulns.ch/disk-images/debian/debian")


      // Read-write local storage for disk blocks, it is used both as a cache and as persisteny writable storage
      const idbDevice = await CheerpX.IDBDevice.create("block1");
      const idbDevice2 = await CheerpX.IDBDevice.create("block2");

      await idbDevice.reset();
      await idbDevice2.reset();

      // Convenient access to JavaScript binary data and strings
      const dataDevice = await CheerpX.DataDevice.create();
      self.dataDevice=dataDevice
      self.idbDevice=idbDevice
      self.idbDevice2=idbDevice2

      // A device to overlay the local changes to the disk with the remote read-only image
      const overlayDevice = await CheerpX.OverlayDevice.create(
        blockDevice,
        idbDevice
      );


      const cx = await CheerpX.Linux.create({
        mounts: [
          { type: "ext2", path: "/", dev: overlayDevice },
          { type: "dir", path: "/data", dev: dataDevice },
          { type: "dir", path: "/home/user/output", dev: idbDevice2 },
          { type: "devs", path: "/dev" },
        ],
      });
      self.cx = cx;


      // xterm.js setup
      const term = new Terminal({ convertEol: true });
      term.open(document.getElementById("console"));

      const term_cols=60;
      const term_rows=40;

      const send = cx.setCustomConsole(
        (buf) => {
          term.write(new Uint8Array(buf));
        },
        term_cols,
        term_rows
      );
      term.onData((str) => {
        for (let i = 0; i < str.length; i++) {
          send(str.charCodeAt(i));
        }
      });



      // start bash
      await cx.run("/bin/bash", ["--login"], {
        env: [
          "HOME=/home/user",
          "USER=user",
          "SHELL=/bin/bash",
          "EDITOR=vim",
          "LANG=en_US.UTF-8",
          "LC_ALL=C",
        ],
        cwd: "/home/user",
        uid: 0,
        gid: 0,
      });
      

    </script>
  </head>
  <body style="height: 100%; background: grey; overflow:hidden">

    <div class="top-section">
        <div class="left-section">
            <h1>File Manager</h1>
            <p class="welcome-text">Drag and drop files to the input area on the right to upload them. Files are stored as blobs in memory. Use the terminal below to interact with the system.</p>
        </div>

        <div class="right-section">
            <div class="drop-area" id="inputArea">
                <div class="area-title">Input Files</div>
<!--                <div class="drop-prompt" id="inputPrompt">Click or drag files here to upload</div>-->
                <div class="file-list" id="inputFileList"></div>
            </div>

            <div class="drop-area" id="outputArea">
                <div class="area-title">
                    <span>Output Files</span>
                    <button class="refresh-btn" id="refreshBtn">â†» Refresh</button>
                </div>
<!--                <div class="drop-prompt" id="outputPrompt">Generated output will appear here</div>-->
                <div class="file-list" id="outputFileList"></div>
            </div>
        </div>
    </div>

    <div class="terminal-section">
        <div id="console"></div>
    </div>

    <input type="file" id="inputFileInput" multiple style="display: none;">
    <input type="file" id="outputFileInput" multiple style="display: none;">

    <script src="main.js"></script>

  </body>
</html>
